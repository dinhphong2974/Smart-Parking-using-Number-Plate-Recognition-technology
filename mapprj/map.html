<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>UAV Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }

    #control-panel {
      position: absolute;
      bottom: 10px;  /* <-- S·ª≠a t·ª´ top th√†nh bottom */
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1000;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      max-height: 40vh;
      overflow-y: auto;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="control-panel"><strong>üõ∞ UAVs:</strong><br/></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([21.0, 105.8], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const colors = ["red", "blue", "green", "orange", "purple", "black"];
    let polylines = {};
    let markers = {};
    let uavVisibility = {};

    function createCheckbox(device_id, color) {
      const panel = document.getElementById("control-panel");
      const id = `checkbox-${device_id}`;
      if (document.getElementById(id)) return;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = id;
      checkbox.checked = true;
      checkbox.onchange = () => { drawPath(); };

      const label = document.createElement("label");
      label.htmlFor = id;
      label.innerHTML = `<span style="color:${color}">‚¨§</span> ${device_id}`;

      panel.appendChild(checkbox);
      panel.appendChild(label);
      panel.appendChild(document.createElement("br"));

      uavVisibility[device_id] = true;
      checkbox.addEventListener("change", () => {
        uavVisibility[device_id] = checkbox.checked;
        drawPath();
      });
    }

    async function drawPath() {
      try {
        const res = await fetch("https://e315ce6523a2.ngrok-free.app/positions.json", {
          headers: { "ngrok-skip-browser-warning": "true" }
        });

        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) return;

        const grouped = {};
        for (const point of data) {
          const id = point.device_id || "Unknown";
          if (!grouped[id]) grouped[id] = [];
          grouped[id].push([point.lat, point.lon]);
        }

        let colorIndex = 0;
        for (const [device_id, latlngs] of Object.entries(grouped)) {
          const color = colors[colorIndex++ % colors.length];
          createCheckbox(device_id, color);

          if (!uavVisibility[device_id]) {
            if (polylines[device_id]) map.removeLayer(polylines[device_id]);
            if (markers[device_id]) map.removeLayer(markers[device_id]);
            continue;
          }

          if (polylines[device_id]) map.removeLayer(polylines[device_id]);
          if (markers[device_id]) map.removeLayer(markers[device_id]);

          polylines[device_id] = L.polyline(latlngs, { color }).addTo(map);
          const last = latlngs[latlngs.length - 1];
          markers[device_id] = L.marker(last).addTo(map)
            .bindPopup(`üõ∏ UAV: ${device_id}`)
            .openPopup();
        }
      } catch (err) {
        console.error("‚ùå L·ªói l·∫•y d·ªØ li·ªáu ho·∫∑c ph√¢n t√≠ch JSON:", err);
      }
    }

    drawPath();
    setInterval(drawPath, 3000);
  </script>
</body>
</html>
